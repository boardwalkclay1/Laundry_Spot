<!DOCTYPE html>
<html>
<head>
  <title>Customer Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .grid { display:grid; grid-template-columns: 2fr 1.5fr; gap:20px; margin-top:20px; }
    .card { background: rgba(10, 15, 30, 0.9); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    #map { width:100%; height:300px; border-radius:12px; overflow:hidden; }
    .btn-row { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .btn-row button { flex:1; min-width:150px; }
  </style>
</head>
<body>

<div class="container">

  <div class="top-bar">
    <div>
      <h2>Customer Dashboard</h2>
      <small id="userEmail"></small>
    </div>
    <div>
      <button onclick="location.href='customer-settings.html'">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="card" id="profilePrompt" style="display:none;">
    <h3>Complete your profile</h3>
    <button onclick="location.href='customer-profile.html'">Set Up Profile</button>
  </div>

  <div class="card" id="paymentPrompt" style="display:none;">
    <h3>Set up your payment</h3>
    <button onclick="location.href='customer-payment.html'">Set Up Payment</button>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>Your Area</h3>
        <div id="map"></div>
      </div>

      <div class="card">
        <h3>Quick Actions</h3>
        <div class="btn-row">
          <button onclick="location.href='customer-request-pickup.html'">Request Pickup</button>
          <button onclick="location.href='customer-request-dropoff.html'">Request Dropoff</button>
          <button onclick="location.href='customer-requests.html'">View My Requests</button>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Overview</h3>
        <div id="summary"></div>
      </div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>
<script>
let currentUser = null;
let googleMapsApiKey = null;

async function init() {
  currentUser = await getCurrentUser();
  if (!currentUser || getRoleFromUser(currentUser) !== "customer") {
    window.location.href = "login.html?role=customer";
    return;
  }

  document.getElementById("userEmail").innerText = currentUser.email;

  const cfg = await loadConfig();
  googleMapsApiKey = cfg.googleMapsApiKey;

  loadSummary();
  loadMapScript();
}

async function logout() {
  await logoutUser();
  window.location.href = "login.html?role=customer";
}

async function loadSummary() {
  const res = await fetch("/api/jobs");
  const data = await res.json();
  const jobs = (data.jobs || []).filter(j => j.customerName === currentUser.email);

  const active = jobs.filter(j => j.status !== "completed");
  const completed = jobs.filter(j => j.status === "completed");

  document.getElementById("summary").innerHTML = `
    <p>Active: <strong>${active.length}</strong></p>
    <p>Completed: <strong>${completed.length}</strong></p>
  `;
}

function loadMapScript() {
  const script = document.createElement("script");
  script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initMap`;
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
}

window.initMap = function() {
  const center = { lat: 33.7490, lng: -84.3880 };
  const map = new google.maps.Map(document.getElementById("map"), {
    center,
    zoom: 11
  });
  new google.maps.Marker({ position: center, map });
};

init();
</script>

</body>
</html>
