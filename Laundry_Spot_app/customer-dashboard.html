<!DOCTYPE html>
<html>
<head>
  <title>Customer Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .top-bar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    .grid {
      display:grid;
      grid-template-columns: 2fr 1.5fr;
      gap:20px;
      margin-top:20px;
    }
    .card {
      background: rgba(10, 15, 30, 0.9);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
      margin-bottom: 15px;
    }
    .card h3 {
      margin-top:0;
    }
    #map {
      width:100%;
      height:300px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.1);
    }
    .btn-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .btn-row button {
      flex:1;
      min-width:150px;
    }
  </style>
</head>
<body>

<div class="container">

  <div class="top-bar">
    <div>
      <h2 id="welcomeText">Your Dashboard</h2>
      <small id="userEmail"></small>
    </div>
    <div>
      <button onclick="goSettings()">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Important prompts up top -->
  <div class="card" id="profilePrompt" style="display:none;">
    <h3>Complete your profile</h3>
    <p>Set your name, default addresses, and preferences so we can serve you better.</p>
    <button onclick="location.href='customer-profile.html'">Set Up Profile</button>
  </div>

  <div class="card" id="paymentPrompt" style="display:none;">
    <h3>Set up your payment</h3>
    <p>Securely add your payment methods with Stripe to pay for pickups and dropoffs.</p>
    <button onclick="location.href='customer-payment.html'">Set Up Payment</button>
  </div>

  <div class="grid">
    <!-- Left side: Map + Quick Actions -->
    <div>
      <div class="card">
        <h3>Your Area</h3>
        <div id="map">
          <!-- Simple placeholder map: replace with real map later -->
          <iframe
            width="100%"
            height="100%"
            style="border:0;"
            loading="lazy"
            allowfullscreen
            referrerpolicy="no-referrer-when-downgrade"
            src="https://www.google.com/maps/embed/v1/place?key=YOUR_GOOGLE_MAPS_API_KEY&q=Gainesville,FL">
          </iframe>
        </div>
      </div>

      <div class="card">
        <h3>Quick Actions</h3>
        <div class="btn-row">
          <button onclick="location.href='customer-request-pickup.html'">
            Request Pickup
          </button>
          <button onclick="location.href='customer-request-dropoff.html'">
            Request Dropoff
          </button>
          <button onclick="location.href='customer-requests.html'">
            View My Requests
          </button>
        </div>
      </div>
    </div>

    <!-- Right side: Overview -->
    <div>
      <div class="card">
        <h3>Overview</h3>
        <p id="overviewText">
          Track your active and past laundry requests here.
        </p>
        <div id="summary"></div>
      </div>

      <div class="card">
        <h3>Shortcuts</h3>
        <div class="btn-row">
          <button onclick="location.href='customer-profile.html'">Profile</button>
          <button onclick="location.href='customer-payment.html'">Payment</button>
          <button onclick="location.href='customer-settings.html'">Settings</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
function getUser() {
  let user = localStorage.getItem("laundryUser");
  if (!user) user = sessionStorage.getItem("laundryUser");
  return user ? JSON.parse(user) : null;
}

// Redirect protection + personalization
const user = getUser();
if (!user || user.role !== "customer") {
  location.href = "login.html?role=customer";
} else {
  document.getElementById("welcomeText").innerText = "Welcome, Customer";
  document.getElementById("userEmail").innerText = user.email;

  if (!user.profileCompleted) {
    document.getElementById("profilePrompt").style.display = "block";
  }
  if (!user.paymentSetup) {
    document.getElementById("paymentPrompt").style.display = "block";
  }
}

function logout() {
  localStorage.removeItem("laundryUser");
  sessionStorage.removeItem("laundryUser");
  location.href = "login.html?role=customer";
}

function goSettings() {
  location.href = "customer-settings.html";
}

// Load summary of jobs
async function loadSummary() {
  try {
    const res = await fetch('/api/jobs');
    const data = await res.json();
    const jobs = data.jobs || [];
    const active = jobs.filter(j => j.status !== "completed");
    const completed = jobs.filter(j => j.status === "completed");

    const summaryDiv = document.getElementById('summary');
    summaryDiv.innerHTML = `
      <p>Active requests: <strong>${active.length}</strong></p>
      <p>Completed requests: <strong>${completed.length}</strong></p>
    `;
  } catch (e) {
    document.getElementById('summary').innerText = "Could not load job summary.";
  }
}

loadSummary();
</script>

</body>
</html>
