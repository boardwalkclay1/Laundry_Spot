<!DOCTYPE html>
<html>
<head>
  <title>Payment Setup</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .card {
      background: rgba(10, 15, 30, 0.9);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    #card-element {
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Payment & Billing</h2>
  <button onclick="location.href='customer-dashboard.html'" style="float:right;">Back</button>

  <div class="card">
    <h3>Add a Card</h3>
    <div id="card-element"></div>
    <button onclick="saveCard()" style="margin-top:10px;">Save Card</button>
    <p id="card-status" style="margin-top:10px;"></p>
  </div>

  <div class="card">
    <h3>Manage Payment Methods</h3>
    <button onclick="openPortal()">Open Stripe Portal</button>
    <p id="portal-status" style="margin-top:10px;"></p>
  </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>
<script>
let stripe, elements, cardElement, currentUser, publishableKey;

async function init() {
  currentUser = await getCurrentUser();
  if (!currentUser || getRoleFromUser(currentUser) !== "customer") {
    window.location.href = "login.html?role=customer";
    return;
  }

  const cfg = await loadConfig();
  publishableKey = cfg.stripePublishableKey;

  stripe = Stripe(publishableKey);
  elements = stripe.elements();

  cardElement = elements.create("card", {
    style: { base: { color: "#fff", "::placeholder": { color: "#888" } } }
  });
  cardElement.mount("#card-element");
}

async function saveCard() {
  document.getElementById("card-status").innerText = "Creating setup intent...";

  const setupRes = await fetch("/api/payments/create-setup-intent", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: currentUser.email })
  });

  const { clientSecret, error } = await setupRes.json();
  if (error || !clientSecret) {
    document.getElementById("card-status").innerText = "Error creating setup intent.";
    return;
  }

  const { error: stripeError } = await stripe.confirmCardSetup(clientSecret, {
    payment_method: { card: cardElement }
  });

  if (stripeError) {
    document.getElementById("card-status").innerText = stripeError.message;
  } else {
    document.getElementById("card-status").innerText = "Card saved successfully!";
  }
}

async function openPortal() {
  document.getElementById("portal-status").innerText = "Opening portal...";

  const res = await fetch("/api/payments/create-portal-session", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: currentUser.email })
  });

  const data = await res.json();
  if (data.url) window.location.href = data.url;
  else document.getElementById("portal-status").innerText = "Error opening portal.";
}

init();
</script>

</body>
</html>
