<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Map â€“ Laundry Bubbles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+e2tu1H1kN1DaS3G1QWgVg0LlwM651c01rbN0i8m8="
    crossorigin=""
  />

  <style>
    body {
      margin:0;
      font-family:Arial,sans-serif;
      background:linear-gradient(135deg,#d96e30,#f4c542);
      height:100vh;
      display:flex;
      flex-direction:column;
      color:#5a3e2b;
    }
    h1 {
      text-align:center;
      padding:10px 10px 0;
      margin:0;
    }
    #statusText {
      text-align:center;
      font-size:0.9rem;
      padding:4px 10px 8px;
      opacity:0.9;
    }
    #map {
      flex:1;
      width:100%;
      border-top:4px solid #d96e30;
      border-bottom:4px solid #d96e30;
    }
    .btn {
      display:block;
      width:100%;
      padding:14px;
      background:#d96e30;
      color:white;
      text-align:center;
      font-weight:bold;
      text-decoration:none;
      border:none;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <h1>Live Order Tracking</h1>
  <div id="statusText">Loading order and washer location...</div>
  <div id="map"></div>
  <a class="btn" id="backBtn">Back to Order</a>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kGStsAkT6PW1s3U3nU5wP0iYv7vCqp5A+4b24="
    crossorigin=""
  ></script>

  <script type="module">
    import { supabase } from "./supabase.js";

    function getOrderId() {
      return new URLSearchParams(window.location.search).get("order_id");
    }

    const orderId = getOrderId();
    const statusText = document.getElementById("statusText");
    const backBtn = document.getElementById("backBtn");
    backBtn.href = `client-order-detail.html?order_id=${orderId}`;

    let washerId = null;

    // Auth: optional here (map can work read-only), but we'll still check
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      // You can choose to force login here if you want:
      // window.location.href = "login.html";
    }

    // -----------------------------
    // 1. Load order to get washer_id
    // -----------------------------
    const { data: order, error: orderError } = await supabase
      .from("orders")
      .select("*")
      .eq("id", orderId)
      .single();

    if (orderError || !order) {
      statusText.innerText = "Could not load this order.";
      throw orderError;
    }

    washerId = order.washer_id;
    if (!washerId) {
      statusText.innerText = "A washer has not been assigned yet. We'll update this map when one is assigned.";
    } else {
      statusText.innerText = "Tracking your washer in real time.";
    }

    // -----------------------------
    // 2. Initialize map
    // -----------------------------
    const defaultCenter = [33.7490, -84.3880]; // Atlanta fallback
    const map = L.map("map").setView(defaultCenter, 12);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom:19,
      attribution:"&copy; OpenStreetMap contributors"
    }).addTo(map);

    let washerMarker = null;

    function updateWasherMarker(lat, lng) {
      if (!washerMarker) {
        washerMarker = L.marker([lat, lng]).addTo(map);
      } else {
        washerMarker.setLatLng([lat, lng]);
      }
    }

    // -----------------------------
    // 3. Load initial washer location
    // -----------------------------
    async function loadInitialLocation() {
      if (!washerId) return;

      const { data: loc, error: locError } = await supabase
        .from("locations")
        .select("*")
        .eq("user_id", washerId)
        .single();

      if (locError || !loc) {
        statusText.innerText = "Washer is assigned, waiting for them to share location...";
        return;
      }

      updateWasherMarker(loc.lat, loc.lng);
      map.setView([loc.lat, loc.lng], 14);
      statusText.innerText = "Tracking your washer in real time.";
    }

    await loadInitialLocation();

    // -----------------------------
    // 4. Realtime updates:
    //    - If washer changes
    //    - If washer location changes
    // -----------------------------

    // Order subscription: to catch washer assignment changes
    supabase
      .channel("order-map-" + orderId)
      .on(
        "postgres_changes",
        { event:"UPDATE", schema:"public", table:"orders", filter:`id=eq.${orderId}` },
        payload => {
          const updated = payload.new;
          if (updated.washer_id && updated.washer_id !== washerId) {
            washerId = updated.washer_id;
            statusText.innerText = "A washer has been assigned. Waiting for their location...";
            loadInitialLocation();
          }
        }
      )
      .subscribe();

    // Locations subscription: track washer movement
    supabase
      .channel("location-updates-map")
      .on(
        "postgres_changes",
        { event:"UPDATE", schema:"public", table:"locations" },
        payload => {
          if (washerId && payload.new.user_id === washerId) {
            updateWasherMarker(payload.new.lat, payload.new.lng);
            statusText.innerText = "Your washer is moving...";
          }
        }
      )
      .subscribe();
  </script>
</body>
</html>
