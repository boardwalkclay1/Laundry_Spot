<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Select Pickup Location – Laundry Bubbles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary:#4da6ff; --accent:#7a5cff; --text:#f9fbff; --muted:#9aa3c7;
    }
    * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui,sans-serif; }

    body {
      background:#030715;
      color:var(--text);
      height:100vh;
      display:flex;
      flex-direction:column;
      padding:14px;
    }

    header {
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }

    .back {
      width:36px; height:36px;
      border-radius:50%;
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.15);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      font-size:18px;
    }

    #map {
      flex:1;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.15);
      overflow:hidden;
    }

    .address-box {
      margin-top:12px;
      background:rgba(255,255,255,0.05);
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.12);
    }

    .address-label {
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }

    .address-value {
      font-size:14px;
      font-weight:600;
    }

    button {
      margin-top:14px;
      width:100%;
      padding:14px;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:white;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
    }
  </style>
</head>

<body>
  <header>
    <div class="back" onclick="window.location.href='request-pickup.html'">←</div>
    <h2>Select Pickup Location</h2>
  </header>

  <div id="map"></div>

  <div class="address-box">
    <div class="address-label">Selected Address</div>
    <div class="address-value" id="addressText">Move the pin to choose a location…</div>
  </div>

  <button onclick="saveLocation()">Confirm Location</button>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB02c_eleXuhHWdSMJzqk9mESbXn_PT2zc&libraries=places"></script>

  <script>
    let map, marker, geocoder;
    let selectedLat = null;
    let selectedLng = null;
    let selectedAddress = "";

    function initMap() {
      geocoder = new google.maps.Geocoder();

      const defaultPos = { lat: 33.7490, lng: -84.3880 };

      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultPos,
        zoom: 14,
        styles: [
          { elementType:"geometry", stylers:[{color:"#1d1d2b"}] },
          { elementType:"labels.text.fill", stylers:[{color:"#f9fbff"}] },
          { featureType:"water", stylers:[{color:"#0b0f1a"}] }
        ]
      });

      marker = new google.maps.Marker({
        position: defaultPos,
        map,
        draggable: true,
        icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
      });

      google.maps.event.addListener(marker, "dragend", function() {
        const pos = marker.getPosition();
        selectedLat = pos.lat();
        selectedLng = pos.lng();
        reverseGeocode(selectedLat, selectedLng);
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userPos = {
              lat: pos.coords.latitude,
              lng: pos.coords.longitude
            };
            map.setCenter(userPos);
            marker.setPosition(userPos);
            selectedLat = userPos.lat;
            selectedLng = userPos.lng;
            reverseGeocode(selectedLat, selectedLng);
          }
        );
      }
    }

    function reverseGeocode(lat, lng) {
      geocoder.geocode({ location: { lat, lng } }, (results, status) => {
        if (status === "OK" && results[0]) {
          selectedAddress = results[0].formatted_address;
          document.getElementById("addressText").textContent = selectedAddress;
        }
      });
    }

    function saveLocation() {
      if (!selectedLat || !selectedLng || !selectedAddress) {
        alert("Please choose a location first.");
        return;
      }

      const loc = {
        lat: selectedLat,
        lng: selectedLng,
        address: selectedAddress
      };

      localStorage.setItem("lb_pickup_location", JSON.stringify(loc));
      window.location.href = "request-pickup.html";
    }

    window.onload = initMap;
  </script>
</body>
</html>
