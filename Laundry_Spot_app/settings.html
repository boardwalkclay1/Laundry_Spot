<script type="module">
  import { supabase } from "./supabase.js";

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) window.location.href = "login.html";

  // Load profile
  async function loadProfile() {
    const { data: profile } = await supabase
      .from("profiles")
      .select("*")
      .eq("id", session.user.id)
      .single();

    document.getElementById("role").value = profile.role || "client";

    if (profile.role === "washer") {
      document.getElementById("washerLink").style.display = "block";
    } else {
      document.getElementById("washerLink").style.display = "none";
    }
  }

  await loadProfile();

  // Save role and redirect properly
  window.saveRole = async function () {
    const newRole = document.getElementById("role").value;

    // Update Supabase
    const { error } = await supabase
      .from("profiles")
      .update({ role: newRole })
      .eq("id", session.user.id);

    if (error) {
      alert("Error saving role.");
      return;
    }

    // Reload profile to update UI
    await loadProfile();

    // Redirect based on new role
    if (newRole === "washer") {
      window.location.href = "washer-dashboard.html";
    } else {
      window.location.href = "dashboard.html";
    }
  };
</script>
