<!DOCTYPE html>
<html>
<head>
  <title>Washer Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .job-card { background: rgba(10, 15, 30, 0.9); padding:10px; border-radius:10px; margin-bottom:10px; }
    .grid { display:grid; grid-template-columns: 2fr 1.5fr; gap:20px; margin-top:20px; }
    .card { background: rgba(10, 15, 30, 0.9); padding:15px; border-radius:12px; margin-bottom:15px; }
    #map { width:100%; height:250px; border-radius:12px; }
  </style>
</head>
<body>

<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h2>Washer Dashboard</h2>
      <small id="washerEmail"></small>
    </div>
    <div>
      <button onclick="location.href='washer-settings.html'">Settings</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <h3>Available Jobs</h3>
        <div id="availableJobs"></div>
      </div>

      <div class="card">
        <h3>Your Accepted Jobs</h3>
        <div id="acceptedJobs"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3>Your Area</h3>
        <div id="map"></div>
      </div>

      <div class="card">
        <h3>Stripe Onboarding</h3>
        <button onclick="location.href='washer-onboarding.html'">Start / Continue</button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="auth.js"></script>
<script>
let currentUser = null;
let googleMapsApiKey = null;

async function init() {
  currentUser = await getCurrentUser();
  if (!currentUser || getRoleFromUser(currentUser) !== "washer") {
    window.location.href = "login.html?role=washer";
    return;
  }

  document.getElementById("washerEmail").innerText = currentUser.email;

  const cfg = await loadConfig();
  googleMapsApiKey = cfg.googleMapsApiKey;

  loadJobs();
  loadMapScript();
}

async function logout() {
  await logoutUser();
  window.location.href = "login.html?role=washer";
}

async function loadJobs() {
  const res = await fetch("/api/jobs");
  const data = await res.json();
  const jobs = data.jobs || [];

  const available = document.getElementById("availableJobs");
  const accepted = document.getElementById("acceptedJobs");

  available.innerHTML = "";
  accepted.innerHTML = "";

  jobs.forEach(job => {
    const div = document.createElement("div");
    div.className = "job-card";
    div.innerHTML = `
      <p><strong>${job.customerName}</strong></p>
      <p>${job.address}</p>
      <p>${job.notes || ""}</p>
      <p>Status: ${job.status}</p>
      ${job.status === "pending" ? `<button onclick="acceptJob(${job.id})">Accept</button>` : ""}
    `;

    if (job.status === "pending") available.appendChild(div);
    if (job.status === "accepted") accepted.appendChild(div);
  });
}

async function acceptJob(id) {
  await fetch(`/api/jobs/${id}/accept`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ washerAccountId: currentUser.email })
  });
  loadJobs();
}

function loadMapScript() {
  const script = document.createElement("script");
  script.src = `https://maps.googleapis.com/maps/api/js?key=${googleMapsApiKey}&callback=initMap`;
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
}

window.initMap = function() {
  const center = { lat: 33.7490, lng: -84.3880 };
  const map = new google.maps.Map(document.getElementById("map"), {
    center,
    zoom: 11
  });
  new google.maps.Marker({ position: center, map });
};

init();
</script>

</body>
</html>
