<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Washer Map – Laundry Bubbles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --primary:#4da6ff;
      --accent:#7a5cff;
      --text:#f9fbff;
      --muted:#9aa3c7;
      --card:rgba(255,255,255,0.06);
    }

    * {
      margin:0;
      padding:0;
      box-sizing:border-box;
      font-family:system-ui,sans-serif;
    }

    body {
      background:#030715;
      color:var(--text);
      height:100vh;
      overflow:hidden;
      position:relative;
    }

    #map {
      width:100%;
      height:100%;
      position:absolute;
      top:0;
      left:0;
      z-index:1;
    }

    /* Header */
    .top-bar {
      position:absolute;
      top:16px;
      left:16px;
      right:16px;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .back-btn {
      width:40px;
      height:40px;
      border-radius:50%;
      background:rgba(0,0,0,0.45);
      border:1px solid rgba(255,255,255,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
      color:var(--text);
      backdrop-filter:blur(6px);
    }

    .title {
      font-size:18px;
      font-weight:600;
      text-shadow:0 0 12px rgba(77,166,255,0.4);
    }

    /* Bottom Drawer */
    .drawer {
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      background:rgba(5,7,18,0.92);
      border-radius:20px 20px 0 0;
      padding:18px;
      border-top:1px solid rgba(255,255,255,0.12);
      transform:translateY(100%);
      transition:0.3s ease;
      z-index:20;
    }

    .drawer.active {
      transform:translateY(0);
    }

    .drawer-title {
      font-size:17px;
      font-weight:600;
      margin-bottom:4px;
    }

    .drawer-sub {
      font-size:13px;
      color:var(--muted);
      margin-bottom:12px;
    }

    .btn {
      width:100%;
      padding:12px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:16px;
      margin-top:10px;
    }

    .btn-primary {
      background:linear-gradient(135deg,var(--primary),var(--accent));
      color:#fff;
      box-shadow:0 12px 28px rgba(77,166,255,0.45);
    }

    .btn-secondary {
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.14);
      color:var(--muted);
    }
  </style>
</head>

<body>

  <!-- Header -->
  <div class="top-bar">
    <div class="back-btn" onclick="window.location.href='washer-dashboard.html'">←</div>
    <div class="title">Nearby Pickups</div>
    <div style="width:40px;"></div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Bottom Drawer -->
  <div class="drawer" id="drawer">
    <div class="drawer-title" id="drawerName">Client</div>
    <div class="drawer-sub" id="drawerMeta"></div>

    <button class="btn btn-secondary" id="msgBtn">Message client</button>
    <button class="btn btn-secondary" id="navBtn">Navigate</button>
    <button class="btn btn-primary" id="acceptBtn">Accept pickup</button>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB02c_eleXuhHWdSMJzqk9mESbXn_PT2zc"></script>

  <script>
    let map;
    let washerMarker;
    let requestMarkers = [];
    let selectedRequest = null;

    const drawer = document.getElementById("drawer");
    const drawerName = document.getElementById("drawerName");
    const drawerMeta = document.getElementById("drawerMeta");

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 33.7490, lng: -84.3880 },
        zoom: 13,
        disableDefaultUI: true,
        styles: [
          { elementType: "geometry", stylers: [{ color: "#1d1d2b" }] },
          { elementType: "labels.text.fill", stylers: [{ color: "#f9fbff" }] },
          { elementType: "labels.text.stroke", stylers: [{ color: "#1d1d2b" }] },
          {
            featureType: "poi",
            stylers: [{ visibility: "off" }]
          }
        ]
      });

      loadWasherLocation();
      loadPickupRequests();
    }

    function loadWasherLocation() {
      if (!navigator.geolocation) return;

      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        map.setCenter({ lat, lng });

        washerMarker = new google.maps.Marker({
          position: { lat, lng },
          map,
          icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        });
      });
    }

    function loadPickupRequests() {
      const history = JSON.parse(localStorage.getItem("lb_pickup_history") || "[]");

      const pending = history
        .map((req, index) => ({ ...req, _index: index }))
        .filter(r => r.status === "pending");

      pending.forEach(req => {
        const marker = new google.maps.Marker({
          position: { lat: req.pickupLat, lng: req.pickupLng },
          map,
          icon: "https://maps.google.com/mapfiles/ms/icons/purple-dot.png"
        });

        marker.addListener("click", () => openDrawer(req));
        requestMarkers.push(marker);
      });
    }

    function openDrawer(req) {
      selectedRequest = req;

      drawerName.textContent = req.clientName || "Client";
      drawerMeta.textContent = `${req.pickupAddress} · ${req.pickupWindow}`;

      drawer.classList.add("active");
    }

    document.getElementById("navBtn").onclick = () => {
      if (!selectedRequest) return;
      const url = `https://www.google.com/maps/dir/?api=1&destination=${selectedRequest.pickupLat},${selectedRequest.pickupLng}`;
      window.open(url, "_blank");
    };

    document.getElementById("msgBtn").onclick = () => {
      if (!selectedRequest) return;

      const washer = JSON.parse(localStorage.getItem("lb_user") || "{}");
      const clientId = selectedRequest.clientId;

      const convId = `conversation_${clientId}_${washer.id}`;
      const raw = localStorage.getItem("lb_conversations");
      const list = raw ? JSON.parse(raw) : [];

      let conv = list.find(c => c.id === convId);
      if (!conv) {
        conv = {
          id: convId,
          clientId,
          washerId: washer.id,
          otherName: selectedRequest.clientName || "Client",
          messages: []
        };
        list.push(conv);
        localStorage.setItem("lb_conversations", JSON.stringify(list));
      }

      localStorage.setItem("lb_active_conversation", convId);
      window.location.href = "inbox.html";
    };

    document.getElementById("acceptBtn").onclick = () => {
      if (!selectedRequest) return;

      const history = JSON.parse(localStorage.getItem("lb_pickup_history") || "[]");
      history[selectedRequest._index].status = "in_progress";

      localStorage.setItem("lb_pickup_history", JSON.stringify(history));

      alert("Pickup accepted!");
      drawer.classList.remove("active");
      window.location.href = "washer-active-loads.html";
    };

    initMap();
  </script>

</body>
</html>
